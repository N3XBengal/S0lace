<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>S0LACE • Settings</title>

  <link rel="shortcut icon" href="favicon.ico" />
  <link rel="stylesheet" href="index.css" />

  <!-- Core systems -->
  <script src="global-hub.js" defer></script>
  <script src="register-sw.js" defer></script>

  <style>
    /* GRID LAYOUT — 3 PANELS PER ROW */
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 30px;
    }

    @media (max-width: 1000px) {
      .settings-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 700px) {
      .settings-grid {
        grid-template-columns: 1fr;
      }
    }

    .settings-panel {
      border: 2px solid var(--border-hard);
      background: var(--panel);
      padding: 16px;
      box-shadow: 0 0 0 1px #000, 0 0 20px rgba(0,0,0,0.7);
      font-family: "Press Start 2P", monospace;
      font-size: 10px;
    }

    .settings-title {
      font-size: 10px;
      color: var(--accent);
      margin-bottom: 12px;
      text-shadow: 0 0 6px var(--accent);
    }

    .settings-section label,
    .settings-section input,
    .settings-section select {
      font-family: "Press Start 2P";
      font-size: 9px;
    }

    .settings-input {
      width: 100%;
      margin-top: 4px;
      padding: 6px 8px;
      border: 2px solid var(--border-hard);
      background: #000;
      color: var(--fg);
      font-family: "Press Start 2P";
      font-size: 9px;
    }

    .settings-btn {
      font-family: "Press Start 2P";
      font-size: 9px;
      padding: 6px 10px;
      border: 2px solid var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
      width: 100%;
      margin-top: 8px;
      cursor: pointer;
      text-align: center;
    }

    .settings-btn:hover {
      background: rgba(0,255,127,0.25);
      box-shadow: 0 0 14px rgba(0,255,127,0.6);
    }

    #cloak-status {
      margin-top: 6px;
      font-size: 9px;
      color: var(--fg-dim);
    }
  </style>
</head>

<body>
<header class="site-header">
  <div class="site-title">S0LACE</div>
  <nav class="site-nav">
    <a href="index.html">Home</a>
    <a href="games.html">Games</a>
    <a href="media.html">Media</a>
    <a href="settings.html" class="active">Settings</a>
    <a href="account.html" class="account-link">
      <img id="account-icon" alt="Account" />
    </a>
  </nav>
</header>

<main>
  <div class="page-header"><h1>Settings</h1></div>

  <!-- ================= GRID ================== -->
  <div class="settings-grid">

    <!-- ============= TAB CLOAK ============== -->
    <section class="settings-panel">
      <div class="settings-title">TAB CLOAKING</div>

      <div class="settings-section">
        <div style="margin-bottom: 6px;">PRESETS ></div>

        <button class="settings-btn" data-cloak-preset="drive">GOOGLE DRIVE</button>
        <button class="settings-btn" data-cloak-preset="schoology">SCHOOLOGY</button>
        <button class="settings-btn" data-cloak-preset="docs">GOOGLE DOCS</button>
        <button class="settings-btn" data-cloak-preset="google">GOOGLE</button>

        <div style="border-top: 2px solid var(--border-hard); margin-top: 12px; padding-top: 12px;">
          <div class="settings-title" style="font-size: 8px;">CUSTOM</div>

          <label>Title
            <input id="cloak-title" class="settings-input" placeholder="My Drive - Google Drive" />
          </label>

          <label>Favicon URL
            <input id="cloak-icon" class="settings-input" placeholder="https://.../favicon.ico" />
          </label>

          <button class="settings-btn" id="apply-custom-cloak">APPLY</button>
          <button class="settings-btn" id="reset-cloak">RESET</button>

          <div id="cloak-status"></div>
        </div>
      </div>
    </section>

    <!-- ============= ACCENT ============== -->
    <section class="settings-panel">
      <div class="settings-title">ACCENT COLOR</div>

      <label><input type="radio" name="accent" value="green" class="accent-radio" /> GREEN</label><br>
      <label><input type="radio" name="accent" value="violet" class="accent-radio" /> VIOLET</label><br>
      <label><input type="radio" name="accent" value="amber" class="accent-radio" /> AMBER</label><br>
      <label><input type="radio" name="accent" value="white" class="accent-radio" /> WHITE</label>
    </section>

    <!-- ============= THEME ============== -->
    <section class="settings-panel">
      <div class="settings-title">THEME</div>

      <label><input type="radio" name="theme" value="dark" class="theme-radio" /> DARK</label><br>
      <label><input type="radio" name="theme" value="baby" class="theme-radio" /> BLUE</label><br>
      <label><input type="radio" name="theme" value="xmas" class="theme-radio" /> GREEN</label>
    </section>

    <!-- ============= BACKGROUND ============== -->
    <section class="settings-panel">
      <div class="settings-title">BACKGROUND</div>

      <select id="bg-mode" class="settings-input">
        <option value="default">DEFAULT (CRT)</option>
        <option value="gif-stars">STARRY GIF</option>
        <option value="custom">CUSTOM URL</option>
      </select>

      <div id="bg-url-row" style="display:none; margin-top: 8px;">
        <label>Background URL
          <input id="bg-url" class="settings-input" placeholder="https://example.com/bg.png" />
        </label>
      </div>
    </section>

    <!-- ============= SECURITY ============== -->
    <section class="settings-panel">
      <div class="settings-title">SECURITY</div>

      <!-- Anti-close toggle remains -->
      <label><input type="checkbox" id="anti-close-toggle" /> ANTI-CLOSE PROTECTION</label>

      <button class="settings-btn" id="blank-launch">LAUNCH IN ABOUT:BLANK</button>
      <div style="font-size:8px; color:var(--fg-dim); margin-top:6px;">
        (auto-launch toggle removed because it conflicted with blank)
      </div>
    </section>

    <!-- ============= STORAGE ============== -->
    <section class="settings-panel">
      <div class="settings-title">STORAGE</div>

      <button class="settings-btn" id="btn-reset-settings">RESET ALL SETTINGS</button>
      <button class="settings-btn" id="btn-clear-media">CLEAR MEDIA CACHE</button>
    </section>

  </div>
  <!-- END GRID -->

</main>

<!-- ====================== SCRIPT LOGIC (unchanged except layout) ====================== -->
<script>
/* All your original settings logic kept exactly the same — 
   cloak system, accent/theme/background, anti-close, blank launch, and sync-on-load.
   Only DOM references updated to match the new layout.
*/

const presetButtons = document.querySelectorAll("[data-cloak-preset]");
const titleInput = document.getElementById("cloak-title");
const iconInput = document.getElementById("cloak-icon");
const applyCustomBtn = document.getElementById("apply-custom-cloak");
const resetBtn = document.getElementById("reset-cloak");
const statusEl = document.getElementById("cloak-status");

const accentRadios = document.querySelectorAll(".accent-radio");
const themeRadios = document.querySelectorAll(".theme-radio");

const bgModeSelect = document.getElementById("bg-mode");
const bgUrlRow = document.getElementById("bg-url-row");
const bgUrlInput = document.getElementById("bg-url");

const antiToggle = document.getElementById("anti-close-toggle");
const blankLaunch = document.getElementById("blank-launch");

const btnResetSettings = document.getElementById("btn-reset-settings");
const btnClearMedia = document.getElementById("btn-clear-media");

const CLOAK_KEY = "s0laceTabCloak";

const PRESETS = {
  drive: {
    title: "My Drive - Google Drive",
    iconHref: "https://ssl.gstatic.com/docs/doclist/images/drive_2022q3_32dp.png",
  },
  schoology: {
    title: "Schoology",
    iconHref: "https://asset-cdn.schoology.com/sites/all/themes/schoology_theme/favicon.ico",
  },
  docs: {
    title: "Document - Google Docs",
    iconHref: "https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico",
  },
  google: {
    title: "Google",
    iconHref: "favicon.ico",
  },
};

function saveCloak(cfg) {
  localStorage.setItem(CLOAK_KEY, JSON.stringify(cfg));
}

function loadCloak() {
  try { return JSON.parse(localStorage.getItem(CLOAK_KEY)); }
  catch { return null; }
}

presetButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    const preset = PRESETS[btn.dataset.cloakPreset];
    if (!preset) return;

    window.S0LACE.applyTabCloak(preset, true);
    saveCloak(preset);

    titleInput.value = preset.title;
    iconInput.value = preset.iconHref;
    statusEl.textContent = "Preset applied.";
  });
});

applyCustomBtn.addEventListener("click", () => {
  const cfg = {
    enabled: true,
    title: titleInput.value.trim(),
    iconHref: iconInput.value.trim(),
  };

  if (!cfg.title) return statusEl.textContent = "Title required.";

  window.S0LACE.applyTabCloak(cfg, true);
  saveCloak(cfg);

  statusEl.textContent = "Custom cloak applied.";
});

resetBtn.addEventListener("click", () => {
  window.S0LACE.clearTabCloak(true);
  localStorage.removeItem(CLOAK_KEY);
  titleInput.value = "";
  iconInput.value = "";
  statusEl.textContent = "Cloak reset.";
});

/* ACCENT */
accentRadios.forEach(r => {
  r.addEventListener("change", () => {
    if (r.checked) window.S0LACE.applyAccent(r.value, true);
  });
});

/* THEME */
themeRadios.forEach(r => {
  r.addEventListener("change", () => {
    if (r.checked) window.S0LACE.applyTheme(r.value, true);
  });
});

/* BACKGROUND */
bgModeSelect.addEventListener("change", () => {
  const mode = bgModeSelect.value;

  bgUrlRow.style.display = mode === "custom" ? "block" : "none";

  const url = mode === "custom" ? bgUrlInput.value.trim() : "";
  window.S0LACE.applyBackground(mode, url, true);
});

bgUrlInput.addEventListener("blur", () => {
  if (bgModeSelect.value === "custom") {
    window.S0LACE.applyBackground("custom", bgUrlInput.value.trim(), true);
  }
});

/* ANTI CLOSE */
antiToggle.checked = localStorage.getItem("s0laceAntiClose") === "1";
antiToggle.addEventListener("change", () => {
  if (antiToggle.checked) window.S0LACE.enableAntiClose();
  else window.S0LACE.disableAntiClose();
});

/* ABOUT:BLANK LAUNCH BUTTON */
blankLaunch.addEventListener("click", () => {
  const win = window.open("about:blank", "_blank");
  if (!win) return alert("Popup blocked — enable popups.");

  win.document.write(`
    <style>
      body { margin:0; background:black; display:flex; align-items:center; justify-content:center; }
      iframe { width:100vw; height:100vh; border:none; }
    </style>
    <iframe src="${location.origin}/index.html"></iframe>
  `);
});

/* RESET & CACHE */
btnResetSettings.addEventListener("click", () => {
  if (!confirm("Reset ALL settings?")) return;

  [
    CLOAK_KEY,
    "s0laceAccent",
    "s0laceTheme",
    "s0laceBgMode",
    "s0laceBgUrl",
    "s0laceAntiClose",
    "s0laceStartupBlank",
    "s0laceMediaCache"
  ].forEach(k => localStorage.removeItem(k));

  location.reload();
});

btnClearMedia.addEventListener("click", () => {
  localStorage.removeItem("s0laceMediaCache");
  alert("Media cache cleared.");
});

/* SYNC ON LOAD */
window.addEventListener("s0lace:settingsLoaded", evt => {
  const { accent, theme, bgMode, bgUrl } = evt.detail;

  accentRadios.forEach(r => r.checked = r.value === accent);
  themeRadios.forEach(r => r.checked = r.value === theme);

  bgModeSelect.value = bgMode;
  if (bgMode === "custom") {
    bgUrlRow.style.display = "block";
    bgUrlInput.value = bgUrl;
  }

  const saved = loadCloak();
  if (saved) {
    titleInput.value = saved.title || "";
    iconInput.value = saved.iconHref || "";
    statusEl.textContent = "Cloak active.";
  }
});
</script>

</body>
</html>
